import boto3
import requests
from botocore.exceptions import ClientError

# Set the AWS region and S3 bucket name
region_name = 'us-east-1'
bucket_name = 'my-bucket-name'

# Use the IMDS endpoint to retrieve the temporary security credentials associated with the IAM role
try:
    metadata_url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/'
    role_name = requests.get(metadata_url).text
    role_url = metadata_url + role_name
    response = requests.get(role_url).json()
    access_key = response['AccessKeyId']
    secret_key = response['SecretAccessKey']
    session_token = response['Token']
except requests.exceptions.RequestException as e:
    print(f'Error retrieving IAM role credentials: {e}')
    raise

# Create an S3 client using the retrieved credentials
s3 = boto3.client('s3', region_name=region_name,
                  aws_access_key_id=access_key,
                  aws_secret_access_key=secret_key,
                  aws_session_token=session_token)

# Upload a file to S3
try:
    with open('/path/to/local/file', 'rb') as file:
        s3.upload_fileobj(file, bucket_name, 'object/key')
except ClientError as e:
    print(f'Error uploading file to S3: {e}')
    raise
