import boto3
import os
import psycopg2
import json
import logging

# AWS RDS database configuration
db_host = os.environ['DB_HOST']
db_name = os.environ['DB_NAME']
db_user = os.environ['DB_USER']
db_pass = os.environ['DB_PASS']

# AWS RDS database connection
def get_db_connection():
    try:
        conn = psycopg2.connect(host=db_host, dbname=db_name, user=db_user, password=db_pass)
        print("Database connected successfully!")
        return conn
    except psycopg2.Error as e:
        print("Error connecting to the database: ", e)
        raise e

# AWS Lambda function handler
def lambda_handler(event, context):
    # Input query
    input_query = event['query']
    
    # Database connection and cursor
    conn = get_db_connection()
    cursor = conn.cursor(cursor_factory=psycopg2.extras.RealDictCursor)
    
    try:
        # Execute the query
        cursor.execute(input_query)
        
        # Fetch all rows from the result set
        result = cursor.fetchall()
        
        # Convert the result to JSON string
        json_result = json.dumps(result)
        
        # Return the JSON result
        return json_result
            
    except Exception as e:
        logging.error("Error executing the query: %s", e)
        raise e
        
    finally:
        # Close the database connection
        conn.close()
