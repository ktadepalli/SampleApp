import psycopg2
import sys
import json
from decimal import Decimal

class DecimalEncoder(json.JSONEncoder):
    def default(self, obj):
        if isinstance(obj, Decimal):
            return float(obj)
        return super().default(obj)

def fetch_data(query):
    # Connect to the database
    conn = psycopg2.connect(database="mydatabase", user="myuser", password="mypassword", host="localhost", port="5432")
    cur = conn.cursor()

    # Execute the query and retrieve up to 100 records
    cur.execute(query)
    rows = cur.fetchall()

    # Close the cursor and database connection
    cur.close()
    conn.close()

    # Check if the size of the rows variable is less than 6MB and the query starts with "SELECT"
    rows_size = sys.getsizeof(json.dumps(rows, cls=DecimalEncoder))
    if rows_size < 6000000 and query.lower().startswith("select"):
        # Return the fetched rows as a JSON string
        return json.dumps(rows, cls=DecimalEncoder)
    else:
        return json.dumps({"error": "Cannot display"})

# Example usage:
query = "SELECT * FROM mytable;"
result = fetch_data(query)
print(result)
